<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>レアリティ別確率・在庫なし抽選機</title>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
            background-color: #f4f4f9;
        }
        h1 { text-align: center; color: #333; }
        h3 { margin-top: 0; }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        /* レアリティ設定エリア */
        .rarity-settings {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 10px;
        }
        .rarity-box {
            text-align: center;
            background: #fafafa;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #eee;
            flex: 1;
            min-width: 80px;
        }
        .rarity-label { font-weight: bold; display: block; margin-bottom: 5px; }
        .rarity-input { width: 60px; text-align: center; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }

        /* レアリティごとの色定義 */
        .color-N { color: #666; }
        .color-R { color: #0066cc; }
        .color-SR { color: #009900; }
        .color-SSR { color: #ff9900; text-shadow: 0px 0px 1px #ffd700; }
        .color-UR { 
            color: #cc00cc; 
            background: linear-gradient(45deg, #f06, #9f6, #06f);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        .item-list {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .item-list th, .item-list td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            text-align: left;
        }
        .item-list th { background-color: #eee; color: #555; }
        
        input[type="text"] {
            width: 95%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            font-weight: bold;
        }

        button {
            cursor: pointer;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.8; }
        button:disabled { background-color: #ccc !important; cursor: not-allowed; }
        
        .btn-add { background-color: #4CAF50; color: white; }
        .btn-remove { background-color: #f44336; color: white; padding: 6px 12px; }
        .btn-reset { background-color: #607d8b; color: white; float: right; font-size: 0.8em;}
        
        .action-area {
            background-color: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .user-input {
            width: 60% !important;
            padding: 12px !important;
            font-size: 1.1em;
        }
        .btn-spin { 
            background-color: #2196F3; 
            color: white; 
            font-size: 1.2em; 
            width: 100%; 
            padding: 15px;
            margin-top: 10px;
        }

        #result-area {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            font-size: 2.0em;
            font-weight: bold;
            color: #333;
            min-height: 1.2em;
            border: 2px dashed #bbb;
            background: #fff;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        .result-highlight {
            background-color: #fff9c4 !important;
            transform: scale(1.05);
        }

        .history-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 300px;
            overflow-y: auto;
            border-top: 1px solid #eee;
        }
        .history-list li {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-list li:nth-child(even) { background-color: #fafafa; }
        .history-time { color: #888; font-size: 0.8em; margin-right: 8px; }
        .history-user { font-weight: bold; color: #555; margin-right: 10px; font-size: 0.9em;}
        
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            margin-right: 5px;
            width: 35px;
            text-align: center;
        }
        .bg-N { background: #eee; color: #333; border: 1px solid #ccc; }
        .bg-R { background: #e3f2fd; color: #0066cc; border: 1px solid #90caf9; }
        .bg-SR { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
        .bg-SSR { background: #fff8e1; color: #f57f17; border: 1px solid #ffecb3; }
        .bg-UR { background: #f3e5f5; color: #7b1fa2; border: 1px solid #e1bee7; }

    </style>
</head>
<body>

    <h1>レアリティ抽選機</h1>

    <div class="card">
        <h3>
            ① レアリティごとの排出割合（重み）
            <small style="font-size:0.7em; font-weight:normal; display:block; color:#666;">※数字が大きいほど出やすくなります。空欄は0扱い。</small>
        </h3>
        <div class="rarity-settings">
            <div class="rarity-box">
                <span class="rarity-label color-N">N</span>
                <input type="number" id="rate-N" class="rarity-input" placeholder="" min="0" onchange="saveData()">
            </div>
            <div class="rarity-box">
                <span class="rarity-label color-R">R</span>
                <input type="number" id="rate-R" class="rarity-input" placeholder="" min="0" onchange="saveData()">
            </div>
            <div class="rarity-box">
                <span class="rarity-label color-SR">SR</span>
                <input type="number" id="rate-SR" class="rarity-input" placeholder="" min="0" onchange="saveData()">
            </div>
            <div class="rarity-box">
                <span class="rarity-label color-SSR">SSR</span>
                <input type="number" id="rate-SSR" class="rarity-input" placeholder="" min="0" onchange="saveData()">
            </div>
            <div class="rarity-box">
                <span class="rarity-label color-UR">UR</span>
                <input type="number" id="rate-UR" class="rarity-input" placeholder="" min="0" onchange="saveData()">
            </div>
        </div>
    </div>

    <div class="card">
        <h3>
            ② 景品リスト
            <button class="btn-reset" onclick="resetData()">⚠ データ初期化</button>
        </h3>
        <div style="margin-bottom:10px; color:#666; font-size:0.9em;">
            ※ 抽選されたレアリティの中から、平等（等確率）に1つ選ばれます。
        </div>
        <table class="item-list">
            <thead>
                <tr>
                    <th>品目名</th>
                    <th style="width: 100px;">レアリティ</th>
                    <th style="width: 50px;">削除</th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>
        <button class="btn-add" onclick="addRow()">＋ 品目を追加</button>
    </div>

    <div class="card action-area">
        <input type="text" id="username" class="user-input" placeholder="回すリスナー名">
        <div style="margin-top: 10px;">
            <label>回数: <input type="number" id="spinCount" value="1" min="1" style="padding: 8px; width: 60px; font-size: 1.1em; border-radius: 4px; border: 1px solid #ccc;"></label>
        </div>
        <button class="btn-spin" id="spinBtn" onclick="spin()">回す</button>
    </div>

    <div id="result-area">結果待ち...</div>

    <div class="card">
        <h3>抽選履歴</h3>
        <ul id="historyList" class="history-list">
            <li style="color: #999; text-align: center;">まだ履歴はありません</li>
        </ul>
    </div>

    <script>
        // バージョンv4: レアリティ管理システムに対応
        const STORAGE_KEY = 'gacha_data_v4';

        window.onload = function() {
            loadData();
        };

        // --- データ保存・読み込み ---

        function saveData() {
            // アイテムリスト保存
            const rows = Array.from(document.querySelectorAll('#tableBody tr'));
            const items = rows.map(row => {
                return {
                    name: row.querySelector('.item-name').value,
                    rarity: row.querySelector('.item-rarity').value
                };
            });

            // レアリティ設定保存
            const rates = {
                N: document.getElementById('rate-N').value,
                R: document.getElementById('rate-R').value,
                SR: document.getElementById('rate-SR').value,
                SSR: document.getElementById('rate-SSR').value,
                UR: document.getElementById('rate-UR').value
            };

            // 履歴保存
            const historyList = document.getElementById('historyList');
            const historyItems = Array.from(historyList.children).map(li => li.innerHTML);

            const data = {
                items: items,
                rates: rates,
                history: historyItems
            };

            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function loadData() {
            const json = localStorage.getItem(STORAGE_KEY);
            const tbody = document.getElementById('tableBody');
            const historyList = document.getElementById('historyList');

            if (json) {
                // 保存データがある場合
                const data = JSON.parse(json);
                
                // レアリティ設定復元
                if (data.rates) {
                    document.getElementById('rate-N').value = data.rates.N || "";
                    document.getElementById('rate-R').value = data.rates.R || "";
                    document.getElementById('rate-SR').value = data.rates.SR || "";
                    document.getElementById('rate-SSR').value = data.rates.SSR || "";
                    document.getElementById('rate-UR').value = data.rates.UR || "";
                }

                // アイテム復元
                tbody.innerHTML = '';
                if (data.items.length > 0) {
                    data.items.forEach(item => addRow(item.name, item.rarity, false));
                }

                // 履歴復元
                if (data.history && data.history.length > 0) {
                    historyList.innerHTML = '';
                    data.history.forEach(html => {
                        const li = document.createElement('li');
                        li.innerHTML = html;
                        historyList.appendChild(li);
                    });
                }
            } else {
                // --- 初回データ生成 ---

                document.getElementById('rate-UR').value = 0.2;
                document.getElementById('rate-SSR').value = 4.1;
                document.getElementById('rate-SR').value = 15.7;
                document.getElementById('rate-R').value = 35;
                document.getElementById('rate-N').value = 45;
                
                // Nレアリティ: アイコンリング1~6
                for(let i=1; i<=6; i++) addRow(`アイコンリング${i}`, 'N', false);
                
                // Rレアリティ: IRIAMヘッダー1~6
                for(let i=1; i<=6; i++) addRow(`IRIAMヘッダー${i}`, 'R', false);
                
                // SRレアリティ: スマホ待受1~5, Simeji背景1~3
                for(let i=1; i<=5; i++) addRow(`スマホ待受${i}`, 'SR', false);
                for(let i=1; i<=3; i++) addRow(`Simeji背景${i}`, 'SR', false);
                
                // SSRレアリティ: PC壁紙1,2, Xヘッダー1,2, ネップリ1~4
                for(let i=1; i<=2; i++) addRow(`PC壁紙${i}`, 'SSR', false);
                for(let i=1; i<=2; i++) addRow(`Xヘッダー${i}`, 'SSR', false);
                for(let i=1; i<=4; i++) addRow(`ネップリ${i}`, 'SSR', false);

                // URレアリティ: アクリルキーホルダ, 缶バッチ1,2
                addRow(`アクリルキーホルダー`, 'UR', false);
                for(let i=1; i<=2; i++) addRow(`缶バッチ${i}`, 'UR', false);

                // 確率入力部分は空白のまま
            }
        }

        function resetData() {
            if(confirm('全てのデータを消去して、初期設定に戻しますか？')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        // --- テーブル操作 ---

        function addRow(name = "", rarity = "N", saveFlag = true) {
            const tbody = document.getElementById('tableBody');
            const row = document.createElement('tr');
            
            // レアリティ選択肢を作成
            const options = ['N', 'R', 'SR', 'SSR', 'UR'].map(r => 
                `<option value="${r}" ${r === rarity ? 'selected' : ''}>${r}</option>`
            ).join('');

            row.innerHTML = `
                <td><input type="text" value="${name}" placeholder="品目名" class="item-name" onchange="saveData()"></td>
                <td>
                    <select class="item-rarity" onchange="saveData()">
                        ${options}
                    </select>
                </td>
                <td><button class="btn-remove" onclick="removeRow(this)">×</button></td>
            `;
            tbody.appendChild(row);
            if (saveFlag) saveData();
        }

        function removeRow(btn) {
            btn.closest('tr').remove();
            saveData();
        }

        // --- 抽選ロジック ---

        function addToHistory(username, itemName, rarity) {
            const historyList = document.getElementById('historyList');
            
            if (historyList.children.length > 0 && historyList.children[0].innerText.includes('履歴はありません')) {
                historyList.innerHTML = '';
            }

            const now = new Date();
            const timeString = now.toLocaleTimeString();

            const li = document.createElement('li');
            li.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <span class="history-time">${timeString}</span>
                    <span class="history-user">${username}</span>
                </div>
                <div style="display:flex; align-items:center;">
                    <span class="badge bg-${rarity}">${rarity}</span>
                    <span class="history-item">${itemName}</span>
                </div>
            `;
            
            historyList.prepend(li);
            saveData(); 
        }

        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        async function spin() {
            const resultArea = document.getElementById('result-area');
            const spinBtn = document.getElementById('spinBtn');
            const usernameInput = document.getElementById('username');
            const countInput = document.getElementById('spinCount');
            
            const username = usernameInput.value.trim() || '名無し';
            let loopCount = parseInt(countInput.value, 10);
            if (isNaN(loopCount) || loopCount < 1) loopCount = 1;

            // 各レアリティのウェイトを取得
            const rarityWeights = {
                N: parseFloat(document.getElementById('rate-N').value) || 0,
                R: parseFloat(document.getElementById('rate-R').value) || 0,
                SR: parseFloat(document.getElementById('rate-SR').value) || 0,
                SSR: parseFloat(document.getElementById('rate-SSR').value) || 0,
                UR: parseFloat(document.getElementById('rate-UR').value) || 0,
            };

            const totalWeight = Object.values(rarityWeights).reduce((a, b) => a + b, 0);

            if (totalWeight <= 0) {
                alert("各レアリティの排出割合（重み）を入力してください！");
                return;
            }

            // アイテムリストをメモリにロード
            const rows = Array.from(document.querySelectorAll('#tableBody tr'));
            const allItems = rows.map(row => ({
                name: row.querySelector('.item-name').value,
                rarity: row.querySelector('.item-rarity').value
            }));

            spinBtn.disabled = true;
            spinBtn.innerText = "抽選中...";

            for (let i = 0; i < loopCount; i++) {
                
                // STEP 1: レアリティ抽選
                let random = Math.random() * totalWeight;
                let selectedRarity = null;
                for (const [rarity, weight] of Object.entries(rarityWeights)) {
                    if (random < weight) {
                        selectedRarity = rarity;
                        break;
                    }
                    random -= weight;
                }
                // 誤差対策
                if (!selectedRarity) selectedRarity = 'N';

                // STEP 2: そのレアリティ内のアイテムから均等に抽選
                const pool = allItems.filter(item => item.rarity === selectedRarity);

                let resultName = "";
                if (pool.length === 0) {
                    resultName = `(エラー: ${selectedRarity}のアイテムがありません)`;
                } else {
                    const randomIndex = Math.floor(Math.random() * pool.length);
                    resultName = pool[randomIndex].name;
                }

                // 結果表示
                resultArea.style.opacity = 0;
                await sleep(100); 
                
                // レアリティごとの色スタイル適用
                const rarityColorClass = `color-${selectedRarity}`;
                resultArea.innerHTML = `${i + 1}回目: <span class="${rarityColorClass}">[${selectedRarity}]</span> ${resultName}`;
                
                resultArea.style.opacity = 1;
                resultArea.classList.add('result-highlight');
                setTimeout(() => resultArea.classList.remove('result-highlight'), 300);

                // 履歴追加
                addToHistory(username, resultName, selectedRarity);

                if (i < loopCount - 1) {
                    await sleep(1200);
                }
            }

            spinBtn.disabled = false;
            spinBtn.innerText = "回す";
        }
    </script>
</body>
</html>
